数字货币合约套利
================
:slug: crypto-coin-arbitrage
:date: 2024-3-12

.. contents::

概述
----
开始前先声明，数字货币市场就是一个不受监管的大赌场，本文只分析合约套利原理，不构成投资建议。永远对市场抱有敬畏之心。投资有风险，入市需谨慎。

首先，我是一个坚定的数字货币反对者。我理解有些人衷爱数字货币，或许因为他们在数字货币的游戏中赚的盆满钵满，或许是他们认为数字货币改变了分配关系，我不去辩驳，毕竟每个人对世界但看法不一样。我认为，数字货币不过是人人都可制造的毫无价值的“货币”。人人都可以发行新的数字货币，就好像人人都可以制造印钞机。既然人人都能制造印钞机，那么印出来的钞票的价值在哪里？所以，数字货币不过是一场零和游戏，有人赚得盆满钵满，就有人亏得血本无归。比特币创立时的美好愿景——去中心化、匿名、币值稳定——更是一个都没有实现。

不过，最近我发现这场游戏有点意思，哪怕不下赌场，也可以了解下赌局的规则，学习下最基本的金融知识，看看赌场里的人生百态。数字货币的游戏规则复杂，但是理解其中的部分规则，也许能在游戏中分一杯羹，或者即便分不到羹，找点乐子也不错。（也许现在说这样的话显得有些过于自信，希望我不会有亏得血本无归得那一天。）

阅读本文需要一些最最基本的期货知识。现在互联网发达，随便一搜都能搜到。

阅读本文前推荐阅读《`无风险年化 360%？小白也能懂的 Crypto 套利 <https://taresky.com/crypto-arbitrage>`_》。本文仅对其中提到的套利原理做简要分析和扩展补充，故不对投资收益和风险做评价，也不给出实际的操作方案。本文介绍的套利分为永续合约套利和交割合约套利，下面进入正题。

永续合约套利
------------

我决定先讲币本位做空的套利，再讲 U 本位做空的套利。因为前者更复杂，搞懂了复杂的东西，简单的东西自然很好理解。如果你觉得币本位太复杂，可以直接跳到 U 本位。

币本位永续合约做空套期保值
..........................

首先明确，永续合约的价格永远向现货价格收敛，即我们可以认为永续合约价格约等于现货价格。原因我们后面解释。所以，这节中我们提到的开仓价和平仓价，既是合约价格，也是现货价格。

币本位合约自带 1 倍做多属性，所以币本位 1 倍做空，相当于抵消了 1 倍做多，永远不会爆仓，具体后面会解释。但是要防范自动减仓（ADL）的风险。

不考虑套利，先看币本位做空永续合约的收益计算。假设杠杆倍数为 N，币本位做空永续合约的收益如下，

.. math::

   收益 (以币计) &= \frac{保证金 (以币计) \times N \times (开仓价 - 平仓价)}{平仓价} &\text{... (1)} \\
                 &= \frac{(合约数 \times 合约面值) / 开仓价 \times N \times (开仓价 - 平仓价)}{平仓价} \\
                 &= 合约数 \times 合约面值 \times N \times (\frac{1}{平仓价} - \frac{1}{开仓价})

上面 (1) 式中，收益变化是由杠杆倍数和币价变动决定的，即 :math:`N \times (开仓价 - 平仓价)` ，但这里的变化是以 U 计的，所以最后需要除以平仓价，将 U 转为币。

因为我们的目的是套利，而不是持币，所以最终的收益要转换为 USDT。理想状况，合约平仓后，立即卖出币转为 USDT，则卖出价格为平仓价，所以以 USDT 计算的收益如下，

.. math::

   收益 (以U计)  &= 收益 + 本金变动 \\
                 &= 收益 (以币计) \times 平仓价 + 保证金 (以币计) \times (平仓价 - 开仓价) & \text{... 带入公式 (1)} \\
                 &= 保证金 (以币计) \times N \times \frac{(开仓价 - 平仓价)}{平仓价} \times 平仓价 + \\
                 & \qquad\qquad 保证金 (以币计) \times (平仓价 - 开仓价) \\
                 &= 保证金 (以币计) \times (N - 1) \times (开仓价 - 平仓价) \\
                 &= \frac{保证金 (以U计)}{开仓价} \times (N - 1) \times (开仓价 - 平仓价) & \text{... (2)} \\

对比 N 倍杠杆的 U 本位做空的收益（即， :math:`保证金 / 开仓价 \times N \times (开仓价 - 平仓价)` ），可以注意到，币本位的实际杠杆变为了 N - 1，这就解释了上面提到了币本位合约自带 1 倍做多属性。有意思的事情发生了，如果以 1 倍杠杆按币本位做空合约，无论币价如何变动，以 U 计的收益永远为 0，这就是币本位合约的套期保值。

举例
....

举例，假设开仓时，一个 BTC 的价格是 50,000 USDT，一张合约面值是等值 100 USDT 的 BTC（即 0.002 BTC）。我们准备买入 100 张 1 倍做空的合约，此时，我们需要 100 * 100 = 10,000 USDT。先将 10,000 USDT 换成 0.2 BTC，再以 0.2 BTC 买入 100 张做空合约。此时，我们就以 1 倍杠杆，用 0.2 BTC 做空了 0.2 BTC（没错，听起来很脑残，但我们就是花了 0.2 BTC 做空了 0.2 BTC，这也就是为什么以 U 计的收益永远为 0 的原因——币价的上涨/下跌永远抵消了做空的亏损/收益）。

假设币价上涨到 100,000 USDT 时，我们平仓，那么我们将收获 0.2 * 1 * (50,000 - 100,000) / 100,000 = -0.1 个 BTC，手上剩余 0.1 个 BTC，卖出 BTC，换为 100,000 * 0.1 = 10,000 USDT。

假设币价下跌到 40,000 USDT 时，我们平仓，那么我们将收获 0.2 * 1 * (50,000 - 40,000) / 40,000 = 0.05 个 BTC，手上剩余 0.25 个 BTC，卖出 BTC，得到 40,000 * 0.25 = 10,000 USDT。

币本位永续合约的多倍做空
........................

理论上来说，在币本位合约套利中，我们基本不会用到多倍做空（否则币价上涨带来的损失将会超过资金费的收益），但是在实际操作中，因为币价波动过快，可能存在滑点。为了防止因为滑点导致的开仓失败，通常会以较小的杠杆进行合约开仓（如 1.01 甚至 1.5 倍）。了解多倍做空有助于理解合约被强平的风险。

现在来考虑 N != 1 的情况。当杠杆倍数不为 1 时，币本位做空会面临强制平仓/爆仓风险。现在我们来计算强平价格。当损失超过保证金，即 :math:`(- 收益) \ge 保证金` 时，会触发强平。所以，将 :math:`收益 = -保证金` 带入 (2) 式中，可以计算出，

.. math::

   强制平仓价 = 开仓价 \times (1 + \frac{1}{N-1})

例如，如果我们以 2 倍杠杆做空，则强平价是 2 倍开仓价，即如果币价上涨一倍，我们就会血本无归。如果以 1.5 倍杠杆做空，则强平价是 3 倍开仓价。如果以 1.01 倍杠杆做空，则强平价是 101 倍开仓价。

U 本位永续合约做空套期保值
..........................

U 本位永续合约套期保值相比币本位永续合约就简单很多了。开仓时，在现货市场买入一定量的币，同时以相同价格在 U 本位永续合约中做空相同数量的币；平仓时，现货与合约的盈亏相抵，本金变化为 0。这就是 U 本位永续合约的套期保值。

U 本位永续合约多倍做空
......................

N 倍杠杆 U 本位做空的收益为 :math:`保证金 / 开仓价 \times N \times (开仓价 - 平仓价)` 。类似地，当合约保证金不足以抵扣做空亏损时，会触发强平，

.. math::

   强制平仓价 = 开仓价 \times (1 + \frac{1}{N})

做空永续合约实现套利
....................

相比交割合约，永续合约没有交割期限，所以合约价格和现货价格可能永不收敛。通过定期（每 8 小时）让需求旺盛的一方向另一方缴纳“资金费”，可以促使需求旺盛的一方平仓以避免“资金费”，这样就能保证合约价格和现货价格基本保持一致。例如，当合约溢价率为正时（即合约价格 > 现货价格），由多头向空头支付资金费，且溢价率越高，资金费率也较高，这会促使多头平仓避免资金费，则合约价格会向现货价格收敛。反之亦然。

市场行情好时，多头旺盛，资金费率高，通过套期保值做空永续合约，可以避免币价波动带来的本金波动，同时还能收取资金费。这就是做空永续合约套利的原理。

做空永续合约的年化收益
......................

懒得敲推导过程了，直接上结论。

.. math::

   币本位年化收益率 &= 资金费率 \times 3 \times 365 \\
   \\
   U 本位年化收益率 &= 资金费率 \times 3 \times 365 \times \frac{N}{N + 1}

可以看出，资金费率相同的情况下，币本位的资金利用率更高。同样是 1 倍杠杆，币本位的资金利用率是 100%，但 U 本位只有 50%。

交易佣金
..........

套利的同时要注意要交易佣金。在没有任何佣金折扣的情况下，OKX 完成一次完整的币本位永续合约套利，交易佣金大约是 0.25%。1 倍杠杆 U 本位佣金是币本位的 1/2，即 0.125%。计算过程留作作业。所以如果是短期套利，交易佣金可能吞噬你的资金费收益。

滑点
....

尽管理论上买入现货和做空合约应当同时进行，且在上面的推导中，我们假设了合约价格 = 现货价格，但实际操作中，操作二者总会有时间差，且主流货币如 BTC 价格波动很快，这就可能导致合约币价 < 现货币价，而出现滑点。

尤其在币本位永续合约中，我们需要先在现货市场买币，再用币作为保证金开仓合约。当合约币价 < 现货币价时，以 1 倍做空和现货等值 USDT 的合约可能需要多于买入的现货币数作为保证金，这可能导致开仓失败。这也是为何币本位合约开仓通常选择略大约 1 的杠杆倍数，以减少保证金数量，避免开仓失败。注意，这里只是合约的杠杆倍数选择略大于 1 以减少保证金，现货购买的币数可能略大于保证金，多余的部分仍然应该留在账户中，平仓时多余的部分也一起平掉，这样保证实际的做空杠杆倍数仍然是 1。

举例，懒得举了，操作一遍就懂了。

交割合约套利
------------

币本位交割合约做空套利
......................

交割合约的币本位做空收益计算比永续合约稍微复杂。上一节已经提到过，永续合约的开仓单价和现货的单价是一样的，这是由每 8 小时收取的资金费率保证的。交割合约在交割日当天期货和现货价差应该收敛至 0 （否则就可以从现货市场买入现货然后在期货市场做空（卖出）交割套利，或在期货市场做多（买入）然后在现货市场卖出套利）。而在还未到期的交割合约中，合约的开仓价通常和现货价格有差异，且距离交割日越远，价差可能越大。因为从当日到交割日还有一段时间，这段时间的资金使用是需要付利息的，而价差的本质就是这段时间资金使用的利息。所以当期货价格 > 现货价格时，我们可以通过在现货市场做多（买入）币，在期货市场做空（卖出）币实现套利。

现在我们来计算币本位交割合约的收益。首先明确，因为交割日当天期货与现货价差趋于 0，所以平仓价是一致的。定义开仓时的价差率如下，

.. math::

   价差率 = \frac{期货开仓价 - 现货开仓价}{现货开仓价}

下面简写期货开仓价为“期开”，现货开仓价为“现开”。根据价差率公式，可得，

.. math::

   期开 = (1 + 价差率) \times 现开 \text{\qquad\qquad ... (3)}

交割合约的以币计算的收益和永续合约的一样，将公式 (1) 中的“开仓价”换为“期开”就完成了。计算公式如下，

.. math::

   收益 (以币计) &= \frac{保证金 (以币计) \times N \times (期开 - 平仓价)}{平仓价}  & \text{... (4)} \\
                 &= \frac{(合约数 \times 合约面值) / 期开 \times N \times (期开 - 平仓价)}{平仓价} \\
                 &= 合约数 \times 合约面值 \times N \times (\frac{1}{平仓价} - \frac{1}{期开}) \\

类似永续合约，我们将以币计算的收益转为以 USDT 计算的收。永续合约中，我们假设了合约价格和现货价格的差总是趋于 0；而交割合约开仓时存在价差，所以计算过程比永续合约复杂，如下，

.. math::

   收益 (以U计)  &= 收益 + 本金变动 \\
                 &= 收益 (以币计) \times 平仓价 + 保证金 (以币计) \times (平仓价 - 现开) & \text{... 带入公式 (4)} \\
                 &= 保证金 (以币计) \times N \times \frac{期开 - 平仓价}{平仓价} \times 平仓价 + \\
                 &  \qquad\qquad 保证金 (以币计) \times (平仓价 - 现开) & \text{... 带入公式 (3)} \\
                 &= 保证金 (以币计) \times N \times ((1 + 价差率) \times 现开 - 平仓价) + \\
                 &  \qquad\qquad 保证金 (以币计) \times (平仓价 - 现开) \\
                 &= 保证金 (以币计) \times \{[(N - 1) + N \times 价差率] \times 现开 - (N - 1) \times 平仓价\} \\
                 &= \frac{保证金 (以U计)}{现开} \times \{[(N - 1) + N \times 价差率] \times 现开 - (N - 1) \times 平仓价\} \\
                 &= 保证金 (以U计) \times [N \times 价差率 - (N - 1)(1 - \frac{平仓价}{现开})]

这个公式可谓相当晦涩难懂了。但是没关系，我们还是使用 1 倍做空，即 N = 1。带入上式，收益就非常简单明了了，

.. math::

    1 倍做空收益 (以U计) = 保证金 (以U计) \times 价差率

从这个公式可以看出，虽然合约是币本位合约，即最终收益是币，但转换为 USDT 时，收益实际与开仓时和平仓时的币价无关。实际上，收益在开仓时，就已经由价差率决定了。

额外插一句，在上式中，如果价差率为 0，即现货开仓价 = 合约开仓价，那么收益公式就和永续合约的收益一样了 :-D

举例
....

假设我们用 ETH 的交割合约套利。开仓时，现货价格为 1,000 USDT/ETH，合约价格为 2,000 USDT/ETH，距离交割日还有 90 天，价差率为 (2000 - 1000)/1000 = 100%。此时我们在现货市场用 10,000 USDT 购入 10 个 ETH，在期货市场用 10 ETH 做空 10 ETH （是不是熟悉的感觉？）。90 天后，现货价格变为 500 USDT/ETH，合约价格收敛至现货价格，此时我们平仓，则我们从合约中赚到了 10 * 1 * (2,000 - 500)/500 = 30 ETH，加上本金 10 ETH，总共 40 ETH。在现货市场卖出 40 ETH，换回 40 * 500 = 20,000 USDT，收益 10,000 USDT，刚好等于保证金（即初始本金）* 价差率。

当然这个例子比较夸张，实际价差率没有那么高啦。

U 本位交割合约做空套利
......................

现在我们介绍了币本位和 U 本位永续合约的套利，又介绍了币本位交割合约的套利，U 本位交割合约的套利自然不在话下，所以我就不写了 (～￣▽￣)～

交割合约套利的年化收益
......................

.. math::

   币本位年化收益率 &= 价差率 \times 365 / 交割剩余天数 \\

U 本位年化收益率留作作业吧。

总结
----

本文介绍了永续合约和交割合约的套利原理，其本质都可以简单地理解为收取资金使用利息。永续合约资金费率时刻变动，所以收益通常不确定，在市场行情好时，资金费率可能很高，收益也高。但数字货币市场千变万化，也许过 8 小时币价大跌，资金费率就变为负的了。而交割的收益通常在开仓时就确定，稳定性更高。另一方面，永续合约可以随时平仓，只要保证不要频繁开平仓，基本能维持正收益（资金费率为正的情况下）；而交割合约在交割前，价差率可能比开仓时更大，此时会出现浮亏，就只能等待价格收敛而不能平仓。

最后再次声明，数字货币市场就是一个不受监管的大赌场，本文只分析合约套利原理，不构成投资建议。永远对市场抱有敬畏之心。投资有风险，入市需谨慎。
